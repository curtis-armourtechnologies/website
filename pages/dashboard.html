<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
</head>
<body>
  <h1>Welcome to Your Dashboard</h1>
  <p>Below is all the information available from Microsoft Graph:</p>

  <div id="user-info">
    <!-- All user info will be displayed here -->
  </div>

  <script>
    // Fetch the authenticated user's data from /auth/me
    fetch('/.auth/me')
      .then(res => res.json())
      .then(data => {
        if (data.clientPrincipal) {
          // If authenticated, get the user's info from Microsoft Graph API
          const accessToken = data.clientPrincipal.accessToken;

          // Make a Graph API call to fetch all user data
          fetch('https://graph.microsoft.com/v1.0/me', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(userData => {
            // Display all the user data on the dashboard
            const userDiv = document.getElementById('user-info');
            userDiv.innerHTML = `<pre>${JSON.stringify(userData, null, 2)}</pre>`;
          })
          .catch(err => {
            console.error('Error fetching user data from Graph API:', err);
            document.getElementById('user-info').innerHTML = '<p>Failed to load user data.</p>';
          });
        } else {
          document.getElementById('user-info').innerHTML = '<p>You are not authenticated.</p>';
        }
      })
      .catch(err => {
        console.error('Error fetching /auth/me:', err);
      });
  </script>
</body>
</html>
